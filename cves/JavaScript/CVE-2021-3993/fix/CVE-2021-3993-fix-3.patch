
diff --git a/server/Application/Home/Controller/UserController.class.php b/server/Application/Home/Controller/UserController.class.php
index 88928fca..afa1f412 100644
--- a/server/Application/Home/Controller/UserController.class.php
+++ b/server/Application/Home/Controller/UserController.class.php
@@ -12,14 +12,16 @@ class UserController extends BaseController {
         exit();
 
 		if (!IS_POST) {
-			  $this->assign('CloseVerify',C('CloseVerify'));
+            $csrf_token = bin2hex(random_bytes(32));
+            session('csrf_token', $csrf_token);
+            $this->assign('csrf_token', $csrf_token);
 			  $this->display ();
 			}else{
 			  $username = I("username");
 			  $password = I("password");
 			  $confirm_password = I("confirm_password");
 			  $v_code = I("v_code");
-			  if (C('CloseVerify') || $v_code && $v_code == session('v_code') ) {
+            if (C('CloseVerify') || ($v_code && $v_code == session('v_code')) && ($csrf_token = I('csrf_token')) && $csrf_token == session('csrf_token')) {
 		  		if ( $password != '' && $password == $confirm_password) {
 
 			  		if ( ! D("User")->isExist($username) ) {
@@ -55,7 +57,9 @@ class UserController extends BaseController {
         exit();
         
 
-		if (!IS_POST) {
+            $csrf_token = bin2hex(random_bytes(32));
+            session('csrf_token', $csrf_token);
+            $this->assign('csrf_token', $csrf_token);
 			//如果有cookie记录，则自动登录
 			$cookie_token = cookie('cookie_token');
 			if ($cookie_token) {
@@ -75,7 +79,7 @@ class UserController extends BaseController {
 		  $username = I("username");
 		  $password = I("password");
 		  $v_code = I("v_code");
-		  if (C('CloseVerify')) { //如果关闭验证码
+            if (C('CloseVerify') || ($v_code && $v_code == session('v_code')) && ($csrf_token = I('csrf_token')) && $csrf_token == session('csrf_token')) {
 		  	$ret = D("User")->checkLogin($username,$password);
 		    if ($ret) {
 		      session("login_user" , $ret );
diff --git a/test_register.php b/test_register.php
new file mode 100644
index 00000000..ad2ffecf
--- /dev/null
+++ b/test_register.php
@@ -0,0 +1,17 @@
+<?php
+include 'server/Application/Home/Controller/UserController.class.php';
+
+// Simulate form data with CSRF token
+$_POST['username'] = 'testuser';
+$_POST['password'] = 'testpassword';
+$_POST['confirm_password'] = 'testpassword';
+$_POST['v_code'] = 'dummycode'; // Assuming v_code is not required or is dummy for this test
+$_SESSION['v_code'] = 'dummycode'; // To bypass v_code check if needed
+$_SESSION['csrf_token'] = 'test_csrf_token'; // Set a test CSRF token in session
+$_POST['csrf_token'] = 'test_csrf_token'; // Include CSRF token in POST data
+
+// Create an instance of UserController
+$userController = new Home\Controller\UserController();
+
+// Call the register function to simulate form submission
+$userController->register();
