
diff --git a/src/main/java/com/mxgraph/online/ProxyServlet.java b/src/main/java/com/mxgraph/online/ProxyServlet.java
index c92987d8..b12c73aa 100644
--- a/src/main/java/com/mxgraph/online/ProxyServlet.java
+++ b/src/main/java/com/mxgraph/online/ProxyServlet.java
@@ -246,39 +246,42 @@ public class ProxyServlet extends HttpServlet
 	/**
 	 * Gets CORS header for request. Returning null means do not respond.
 	 */
-	protected String getCorsDomain(String referer, String userAgent)
-	{
-		String dom = null;
+protected String getCorsDomain(String referer, String userAgent)
+{
+    String dom = null;
 
-		if (referer != null && referer.toLowerCase()
-				.matches("https?://([a-z0-9,-]+[.])*draw[.]io/.*"))
-		{
-			dom = referer.toLowerCase().substring(0,
-					referer.indexOf(".draw.io/") + 8);
-		}
-		else if (referer != null && referer.toLowerCase()
-				.matches("https?://([a-z0-9,-]+[.])*diagrams[.]net/.*"))
-		{
-			dom = referer.toLowerCase().substring(0,
-					referer.indexOf(".diagrams.net/") + 13);
-		}
-		else if (referer != null && referer.toLowerCase()
-				.matches("https?://([a-z0-9,-]+[.])*quipelements[.]com/.*"))
-		{
-			dom = referer.toLowerCase().substring(0,
-					referer.indexOf(".quipelements.com/") + 17);
-		}
-		// Enables Confluence/Jira proxy via referer or hardcoded user-agent (for old versions)
-		// UA refers to old FF on macOS so low risk and fixes requests from existing servers
-		else if ((referer != null
-				&& referer.equals("draw.io Proxy Confluence Server"))
-				|| (userAgent != null && userAgent.equals(
-						"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:50.0) Gecko/20100101 Firefox/50.0")))
-		{
-			dom = "";
-		}
+    // List of allowed domains
+    List<String> allowedDomains = Arrays.asList(
+        "https://draw.io",
+        "https://diagrams.net",
+        "https://quipelements.com"
+    );
 
-		return dom;
-	}
+    // Check if the referer is from an allowed domain
+    if (referer != null) {
+        try {
+            URL refererUrl = new URL(referer);
+            String host = refererUrl.getHost();
+
+            if (allowedDomains.contains("https://" + host)) {
+                dom = "https://" + host;
+            }
+        } catch (MalformedURLException e) {
+            // Log and handle error if the URL is malformed
+            log.log(Level.SEVERE, "Malformed URL in referer", e);
+        }
+    }
+
+    // Enables Confluence/Jira proxy via referer or hardcoded user-agent (for old versions)
+    // UA refers to old FF on macOS so low risk and fixes requests from existing servers
+    else if ((referer != null
+            && referer.equals("draw.io Proxy Confluence Server"))
+            || (userAgent != null && userAgent.equals(
+                "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:50.0) Gecko/20100101 Firefox/50.0"))) {
+        dom = "";
+    }
+
+    return dom;
+}
 
 }
