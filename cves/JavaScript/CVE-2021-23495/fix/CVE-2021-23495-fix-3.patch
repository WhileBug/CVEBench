
diff --git a/client/karma.js b/client/karma.js
index 50651037..2702c4bc 100644
--- a/client/karma.js
+++ b/client/karma.js
@@ -9,7 +9,10 @@ function Karma (updater, socket, iframe, opener, navigator, location, document)
   var queryParams = util.parseQueryParams(location.search)
   var browserId = queryParams.id || util.generateId('manual-')
   var displayName = queryParams.displayName
-  var returnUrl = queryParams['return_url' + ''] || null
+var returnUrl = queryParams['return_url' + ''] || null;
+if (returnUrl && !/^(\/|https:\/\/trusteddomain\.com)/.test(returnUrl)) {
+    returnUrl = null; // Invalidate the returnUrl if it's not relative or from a trusted domain
+}
 
   var resultsBufferLimit = 50
   var resultsBuffer = []
diff --git a/lib/config.js b/lib/config.js
index cd9510bf..28d13c46 100644
--- a/lib/config.js
+++ b/lib/config.js
@@ -50,6 +50,9 @@ class Pattern {
 
 class UrlPattern extends Pattern {
   constructor (url, type) {
+    if (!/^(\/|https:\/\/trusteddomain\.com)/.test(url)) {
+      throw new Error('Unsafe URL pattern');
+    }
     super(url, false, true, false, false, type)
   }
 }
diff --git a/static/karma.js b/static/karma.js
index f0b2548a..f827dd98 100644
--- a/static/karma.js
+++ b/static/karma.js
@@ -19,7 +19,10 @@ function Karma (updater, socket, iframe, opener, navigator, location, document)
   var queryParams = util.parseQueryParams(location.search)
   var browserId = queryParams.id || util.generateId('manual-')
   var displayName = queryParams.displayName
-  var returnUrl = queryParams['return_url' + ''] || null
+var returnUrl = queryParams['return_url' + ''] || null;
+if (returnUrl && !/^(\/|https:\/\/trusteddomain\.com)/.test(returnUrl)) {
+    returnUrl = null; // Invalidate the returnUrl if it's not relative or from a trusted domain
+}
 
   var resultsBufferLimit = 50
   var resultsBuffer = []
