
diff --git a/test_protocol_sanitization.php b/test_protocol_sanitization.php
new file mode 100644
index 0000000000..dcfb3f683b
--- /dev/null
+++ b/test_protocol_sanitization.php
@@ -0,0 +1,19 @@
+<?php
+include 'wp-includes/kses.php';
+
+$test_strings = [
+    'javascript:alert(1)', // Common XSS attack vector
+    'data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==', // Base64 encoded script
+    'vbscript:msgbox("XSS")', // VBScript attack vector
+    'HTTP://www.example.com', // Allowed protocol, should not be sanitized
+    'https://www.example.com', // Allowed protocol, should not be sanitized
+    'feed:https://www.example.com' // Potentially dangerous, but allowed in some contexts
+];
+
+$allowed_protocols = ['http', 'https', 'mailto', 'feed'];
+
+foreach ($test_strings as $string) {
+    $sanitized = wp_kses_bad_protocol_once($string, $allowed_protocols);
+    echo "Original: $string\nSanitized: $sanitized\n\n";
+}
+?>
diff --git a/wp-includes/kses.php b/wp-includes/kses.php
index b707dca813..c6eb4bea54 100644
--- a/wp-includes/kses.php
+++ b/wp-includes/kses.php
@@ -1664,23 +1664,27 @@ function wp_kses_html_error( $string ) {
  * @return string Sanitized content.
  */
 function wp_kses_bad_protocol_once( $string, $allowed_protocols, $count = 1 ) {
-	$string2 = preg_split( '/:|&#0*58;|&#x0*3a;/i', $string, 2 );
-	if ( isset( $string2[1] ) && ! preg_match( '%/\?%', $string2[0] ) ) {
-		$string   = trim( $string2[1] );
-		$protocol = wp_kses_bad_protocol_once2( $string2[0], $allowed_protocols );
-		if ( 'feed:' == $protocol ) {
-			if ( $count > 2 ) {
-				return '';
-			}
-			$string = wp_kses_bad_protocol_once( $string, $allowed_protocols, ++$count );
-			if ( empty( $string ) ) {
-				return $string;
-			}
-		}
-		$string = $protocol . $string;
-	}
-
-	return $string;
+    $string2 = preg_split( '/:|&#0*58;|&#x0*3a;/i', $string, 2 );
+    if ( isset( $string2[1] ) && ! preg_match( '%/\?%', $string2[0] ) ) {
+        $string   = trim( $string2[1] );
+        $protocol = wp_kses_bad_protocol_once2( $string2[0], $allowed_protocols );
+        if ( !in_array(strtolower($protocol), array_map('strtolower', $allowed_protocols)) ) {
+            return ''; // Disallow the protocol entirely if not allowed
+        }
+        if ( 'feed:' == $protocol ) {
+            if ( $count > 2 ) {
+                return '';
+            }
+            $string = wp_kses_bad_protocol_once( $string, $allowed_protocols, ++$count );
+            if ( empty( $string ) ) {
+                return $string;
+            }
+        }
+        $string = $protocol . $string;
+    }
+
+    return $string;
+}
 }
 
 /**
